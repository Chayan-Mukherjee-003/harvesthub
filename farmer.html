<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harvest Hub - Farmer Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop, .sidebar-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        /* Simple animation for status change */
        @keyframes flash {
            0%, 100% { background-color: transparent; }
            50% { background-color: #dcfce7; } /* green-100 */
        }
        .flash-update {
            animation: flash 1s ease-out;
        }
        aside {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="relative min-h-screen md:flex">
        <div id="sidebar-backdrop" class="sidebar-backdrop fixed inset-0 z-20 hidden"></div>

        <aside id="sidebar" class="w-64 bg-white border-r fixed inset-y-0 left-0 z-30 transform -translate-x-full md:relative md:translate-x-0">
            <div class="flex flex-col h-full">
                <div class="h-16 flex items-center justify-center border-b">
                    <a href="#" class="text-2xl font-bold text-green-600">Harvest Hub</a>
                </div>
                <nav class="flex-1 p-4 space-y-2" id="main-nav">
                    <a href="#" data-view="orders" class="flex items-center px-4 py-2 text-white bg-green-600 rounded-md">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        Orders
                    </a>
                    <a href="#" data-view="crops" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18M3 9h18M3 15h18M3 21h18"></path></svg>
                        My Crops
                    </a>
                    <a href="#" data-view="profile" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        Profile
                    </a>
                </nav>
                <div class="p-4 border-t">
                     <a href="#" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        Logout
                    </a>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 flex items-center justify-between px-6 bg-white border-b">
                 <div class="flex items-center">
                    <button id="mobile-menu-btn" class="md:hidden mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 id="page-title" class="text-xl md:text-2xl font-semibold text-gray-800">Incoming Orders</h1>
                 </div>
                 <div id="welcome-message" class="flex items-center font-semibold text-sm sm:text-base">
                    Welcome, Ram Singh
                 </div>
            </header>
            
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-6">
                <div id="orders-view" class="view">
                    <div id="order-list" class="space-y-4">
                        </div>
                </div>

                <div id="crops-view" class="view hidden">
                    <div class="flex justify-end mb-4">
                        <button id="add-crop-btn" class="bg-green-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-700">Add New Crop</button>
                    </div>
                    <div id="crop-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                       </div>
                </div>
                
                <div id="profile-view" class="view hidden">
                    <div class="bg-white p-6 md:p-8 rounded-lg shadow-md max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6">Your Profile</h2>
                        <div class="space-y-4">
                            <div id="profile-name-container">
                                <label class="font-semibold text-gray-600">Name</label>
                                <p id="profile-name" class="text-lg">Ram Singh</p>
                            </div>
                             <div id="profile-location-container">
                                <label class="font-semibold text-gray-600">Location</label>
                                <p id="profile-location" class="text-lg">Bhopal, MP</p>
                            </div>
                            <div>
                                <label class="font-semibold text-gray-600">Kisan Card ID</label>
                                <p id="profile-kisan-id" class="text-lg">KCC-XXXX-1234</p>
                            </div>
                             <div>
                                <label class="font-semibold text-gray-600">Rating</label>
                                <p id="profile-rating" class="text-lg flex items-center"><span class="text-yellow-500 mr-1">★</span> 4.8</p>
                            </div>
                        </div>
                        <div id="profile-actions" class="mt-6">
                            <button id="edit-profile-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-600">Edit Profile</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="crop-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form id="crop-form" class="p-6 space-y-4">
                <h2 id="modal-title" class="text-2xl font-semibold">Add New Crop</h2>
                <input type="hidden" id="crop-id">
                <div>
                    <label for="crop-name" class="block font-medium">Crop Name</label>
                    <input type="text" id="crop-name" class="w-full mt-1 p-2 border rounded-md" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="crop-price" class="block font-medium">Price (₹)</label>
                        <input type="number" id="crop-price" class="w-full mt-1 p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="crop-unit" class="block font-medium">Unit</label>
                        <input type="text" id="crop-unit" placeholder="e.g., kg, quintal" class="w-full mt-1 p-2 border rounded-md" required>
                    </div>
                </div>
                 <div>
                    <label for="crop-type" class="block font-medium">Type</label>
                    <select id="crop-type" class="w-full mt-1 p-2 border rounded-md">
                        <option value="Ready-Made">Ready-Made</option>
                        <option value="To-be-Made">To-be-Made</option>
                    </select>
                </div>
                <div id="eta-container" class="hidden">
                    <label for="crop-eta" class="block font-medium">Estimated Time</label>
                    <input type="text" id="crop-eta" placeholder="e.g., 3 months" class="w-full mt-1 p-2 border rounded-md">
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-crop-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Save Crop</button>
                </div>
            </form>
        </div>
    </div>
    
<script>


const API_HOST = (location.protocol === 'file:') ? 'http://localhost:4000' : '';
const API_BASE = `${API_HOST}/api/farmer`;

function authHeaders() {
  const token = localStorage.getItem('token');
  return token ? { 'Authorization': 'Bearer ' + token } : {};
}

async function farmerRegister(data) {
  const res = await fetch(`${API_BASE}/register`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  return res.json();
}

async function farmerLogin(credentials) {
  const res = await fetch(`${API_BASE}/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(credentials)
  });
  const json = await res.json();
  if (json.token) localStorage.setItem('token', json.token);
  return json;
}

async function fetchCrops() {
  const res = await fetch(`${API_BASE}/crops`, {
    headers: { ...authHeaders() }
  });
  if (!res.ok) {
    console.error('Failed to fetch crops', res.status);
    return [];
  }
  return res.json();
}

async function createCrop(crop) {
  // If backend expects JSON:
  const res = await fetch(`${API_BASE}/crops`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeaders() },
    body: JSON.stringify(crop)
  });
  return res.json();
}

function renderCrops(items = []) {
  const container = document.getElementById('cropsList');
  if (!container) return;
  container.innerHTML = items.length
    ? items.map(c => `<div class="crop-item"><strong>${escapeHtml(c.name)}</strong> — ${c.quantity} @ ${c.price}</div>`).join('')
    : '<div>No crops found</div>';
}

function escapeHtml(str='') {
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

document.addEventListener('DOMContentLoaded', () => {
  // auto-load crops
  fetchCrops().then(renderCrops).catch(e => console.error(e));

  const regForm = document.getElementById('registerForm');
  if (regForm) {
    regForm.addEventListener('submit', async e => {
      e.preventDefault();
      const form = new FormData(regForm);
      const payload = {
        name: form.get('name'),
        email: form.get('email'),
        password: form.get('password')
      };
      const res = await farmerRegister(payload);
      console.log('register result', res);
      alert(res.message || JSON.stringify(res));
    });
  }

  const loginForm = document.getElementById('loginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', async e => {
      e.preventDefault();
      const form = new FormData(loginForm);
      const payload = { email: form.get('email'), password: form.get('password') };
      const res = await farmerLogin(payload);
      console.log('login result', res);
      alert(res.message || (res.token ? 'Logged in' : JSON.stringify(res)));
    });
  }

  const cropForm = document.getElementById('cropForm');
  if (cropForm) {
    cropForm.addEventListener('submit', async e => {
      e.preventDefault();
      const form = new FormData(cropForm);
      // if you have an image upload handled by backend, use FormData and adjust endpoint accordingly.
      const payload = {
        name: form.get('name'),
        price: Number(form.get('price') || 0),
        quantity: Number(form.get('quantity') || 0),
        description: form.get('description') || ''
      };
      const res = await createCrop(payload);
      console.log('create crop', res);
      alert(res.message || JSON.stringify(res));
      // refresh list
      fetchCrops().then(renderCrops).catch(e => console.error(e));
    });
  }
});

document.addEventListener('DOMContentLoaded', () => {
    
    // --- MOCK DATA ---
    const farmerProfile = {
        name: 'Ram Singh',
        location: 'Bhopal, MP',
        rating: 4.8,
        kisanId: 'KCC-XXXX-1234'
    };
    
    let crops = [
        { id: 101, name: 'Tomatoes', type: 'Ready-Made', price: 30, unit: 'kg', image: 'https://placehold.co/400x300/EF4444/FFFFFF?text=Tomatoes' },
        { id: 102, name: 'Potatoes', type: 'Ready-Made', price: 20, unit: 'kg', image: 'https://placehold.co/400x300/FBBF24/FFFFFF?text=Potatoes' },
        { id: 103, name: 'Wheat', type: 'To-be-Made', price: 2500, unit: 'quintal', eta: '3 months', image: 'https://placehold.co/400x300/F59E0B/FFFFFF?text=Wheat' },
    ];

    let orders = [
        { id: 'RT003', retailer: 'Fresh Veggies Co.', deliveryDate: '2025-09-22', totalValue: 2500, status: 'Pending', items: [{ name: 'Potatoes', qty: 125, unit: 'kg' }] },
        { id: 'RT001', retailer: 'Daily Needs Store', deliveryDate: '2025-09-20', totalValue: 1500, status: 'Processing', items: [{ name: 'Tomatoes', qty: 50, unit: 'kg' }] },
        { id: 'RT002', retailer: 'FarmFresh Grocers', deliveryDate: '2025-12-15', totalValue: 12500, status: 'Processing', items: [{ name: 'Wheat', qty: 5, unit: 'quintal' }] },
        { id: 'RT004', retailer: 'Daily Needs Store', deliveryDate: '2025-09-18', totalValue: 600, status: 'Ready for Delivery', items: [{ name: 'Tomatoes', qty: 20, unit: 'kg' }] }
    ];

    // --- DOM ELEMENTS ---
    const pageTitle = document.getElementById('page-title');
    const orderList = document.getElementById('order-list');
    const cropList = document.getElementById('crop-list');
    const cropModal = document.getElementById('crop-modal');
    const cropForm = document.getElementById('crop-form');
    const sidebar = document.getElementById('sidebar');
    const sidebarBackdrop = document.getElementById('sidebar-backdrop');
    const welcomeMessage = document.getElementById('welcome-message');
    const profileActions = document.getElementById('profile-actions');
    
    // --- RENDER FUNCTIONS ---
    function renderOrders() {
        orders.sort((a, b) => new Date(a.deliveryDate) - new Date(b.deliveryDate));
        
        orderList.innerHTML = '';
        if (orders.length === 0) {
            orderList.innerHTML = `<p class="text-center text-gray-500">No active orders.</p>`;
            return;
        }

        orders.forEach(order => {
            let statusColor, actions;
            switch(order.status) {
                case 'Pending':
                    statusColor = 'bg-yellow-100 text-yellow-800';
                    actions = `<button data-order-id="${order.id}" class="accept-order-btn w-full md:w-auto bg-green-500 text-white px-3 py-2 rounded-md text-sm font-semibold hover:bg-green-600">Accept</button>`;
                    break;
                case 'Processing':
                    statusColor = 'bg-blue-100 text-blue-800';
                    actions = `<button data-order-id="${order.id}" class="update-status-btn w-full md:w-auto bg-blue-500 text-white px-3 py-2 rounded-md text-sm font-semibold hover:bg-blue-600">Mark as Ready</button>`;
                    break;
                case 'Ready for Delivery':
                    statusColor = 'bg-indigo-100 text-indigo-800';
                    actions = `<button data-order-id="${order.id}" class="complete-delivery-btn w-full md:w-auto bg-indigo-500 text-white px-3 py-2 rounded-md text-sm font-semibold hover:bg-indigo-600">Complete Delivery</button>`;
                    break;
                default:
                    statusColor = 'bg-gray-100 text-gray-800';
                    actions = '';
            }
            const upfrontPayment = (order.totalValue * 0.20).toFixed(2);
            const orderCard = `
                <div class="bg-white p-4 rounded-lg shadow-md" data-order-card-id="${order.id}">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                        <div class="flex-grow">
                            <p class="font-bold text-lg">${order.retailer}</p>
                            <p class="text-sm text-gray-500">Order ID: ${order.id}</p>
                            <p class="font-semibold mt-2">Delivery By: ${new Date(order.deliveryDate).toLocaleDateString('en-IN')}</p>
                            <p class="text-sm text-gray-600">${order.items.map(i => `${i.qty} ${i.unit} ${i.name}`).join(', ')}</p>
                        </div>

                        <div class="flex flex-col items-start md:items-end space-y-3 md:space-y-2 flex-shrink-0 md:ml-6">
                            <div class="text-left md:text-right">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">${order.status}</span>
                                <p class="font-bold text-xl mt-1">₹${order.totalValue.toFixed(2)}</p>
                                ${order.status === 'Pending' ? `<p class="text-xs text-green-600 font-medium">(₹${upfrontPayment} upfront)</p>` : ''}
                            </div>
                            <div class="w-full md:w-auto">${actions}</div>
                        </div>
                    </div>
                </div>
            `;
            orderList.innerHTML += orderCard;
        });
    }
    
    function renderCrops() {
        cropList.innerHTML = '';
        crops.forEach(crop => {
            const cropCard = `
                <div class="bg-white p-4 rounded-lg shadow-md flex flex-col">
                    <img src="${crop.image}" class="w-full h-40 object-cover rounded-md mb-4">
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold">${crop.name}</h3>
                        <p class="font-semibold text-green-600">₹${crop.price} / ${crop.unit}</p>
                        <p class="text-sm text-gray-500">${crop.type}${crop.eta ? ` (${crop.eta})` : ''}</p>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button data-crop-id="${crop.id}" class="edit-crop-btn flex-1 bg-gray-200 text-gray-800 px-3 py-1.5 rounded-md text-sm font-semibold hover:bg-gray-300">Edit</button>
                        <button data-crop-id="${crop.id}" class="delete-crop-btn flex-1 bg-red-100 text-red-700 px-3 py-1.5 rounded-md text-sm font-semibold hover:bg-red-200">Delete</button>
                    </div>
                </div>
            `;
            cropList.innerHTML += cropCard;
        });
    }

    function renderProfile() {
        document.getElementById('profile-name').textContent = farmerProfile.name;
        document.getElementById('profile-location').textContent = farmerProfile.location;
        document.getElementById('profile-kisan-id').textContent = farmerProfile.kisanId;
        document.getElementById('profile-rating').innerHTML = `<span class="text-yellow-500 mr-1">★</span> ${farmerProfile.rating}`;
        // Update header welcome message
        welcomeMessage.textContent = `Welcome, ${farmerProfile.name}`;
    }

    // --- SIDEBAR & NAVIGATION ---
    function toggleSidebar() {
        sidebar.classList.toggle('-translate-x-full');
        sidebarBackdrop.classList.toggle('hidden');
    }

    document.getElementById('mobile-menu-btn').addEventListener('click', toggleSidebar);
    sidebarBackdrop.addEventListener('click', toggleSidebar);
    
    document.getElementById('main-nav').addEventListener('click', (e) => {
        if (e.target.closest('a')) {
            const link = e.target.closest('a');
            const view = link.dataset.view;
            if (!view) return;

            // Switch view
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`${view}-view`).classList.remove('hidden');
            
            // Update nav link styles
            document.querySelectorAll('#main-nav a').forEach(a => {
                a.classList.remove('bg-green-600', 'text-white');
                a.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            link.classList.add('bg-green-600', 'text-white');
            link.classList.remove('text-gray-600', 'hover:bg-gray-100');
            
            // Update page title
            const titleMap = {
                orders: 'Incoming Orders',
                crops: 'My Crops',
                profile: 'Profile'
            };
            pageTitle.textContent = titleMap[view] || 'Dashboard';
            
            // Close sidebar on mobile after navigation
            if (window.innerWidth < 768) {
                toggleSidebar();
            }
        }
    });

    // --- EVENT LISTENERS ---
    
    // Order Actions
    orderList.addEventListener('click', e => {
        const button = e.target.closest('button');
        if (!button) return;
        
        const orderId = button.dataset.orderId;
        if (!orderId) return;

        const order = orders.find(o => o.id === orderId);

        if (button.classList.contains('accept-order-btn')) {
            order.status = 'Processing';
        } else if (button.classList.contains('update-status-btn')) {
            order.status = 'Ready for Delivery';
        } else if (button.classList.contains('complete-delivery-btn')) {
            orders = orders.filter(o => o.id !== orderId);
        }
        
        renderOrders();
        const updatedCard = document.querySelector(`[data-order-card-id="${orderId}"]`);
        if(updatedCard) {
            updatedCard.classList.add('flash-update');
            updatedCard.addEventListener('animationend', () => {
                updatedCard.classList.remove('flash-update');
            }, { once: true });
        }
    });
    
    // Crop Actions
    document.getElementById('add-crop-btn').addEventListener('click', () => {
        cropForm.reset();
        document.getElementById('modal-title').textContent = 'Add New Crop';
        document.getElementById('crop-id').value = '';
        document.getElementById('eta-container').classList.add('hidden');
        cropModal.classList.remove('hidden');
    });

    cropList.addEventListener('click', e => {
        const button = e.target.closest('button');
        if (!button) return;

        const cropId = button.dataset.cropId;
        if (!cropId) return;

        if (button.classList.contains('edit-crop-btn')) {
            const crop = crops.find(c => c.id == cropId);
            document.getElementById('modal-title').textContent = 'Edit Crop';
            document.getElementById('crop-id').value = crop.id;
            document.getElementById('crop-name').value = crop.name;
            document.getElementById('crop-price').value = crop.price;
            document.getElementById('crop-unit').value = crop.unit;
            document.getElementById('crop-type').value = crop.type;
            document.getElementById('crop-eta').value = crop.eta || '';
            document.getElementById('eta-container').classList.toggle('hidden', crop.type !== 'To-be-Made');
            cropModal.classList.remove('hidden');
        }

        if (button.classList.contains('delete-crop-btn')) {
            if (confirm('Are you sure you want to delete this crop?')) {
                crops = crops.filter(c => c.id != cropId);
                renderCrops();
            }
        }
    });

    // Crop Modal Form
    document.getElementById('crop-type').addEventListener('change', e => {
        document.getElementById('eta-container').classList.toggle('hidden', e.target.value !== 'To-be-Made');
    });

    document.getElementById('cancel-crop-btn').addEventListener('click', () => {
        cropModal.classList.add('hidden');
    });

    cropForm.addEventListener('submit', e => {
        e.preventDefault();
        const id = document.getElementById('crop-id').value;
        const cropData = {
            id: id ? parseInt(id) : Date.now(),
            name: document.getElementById('crop-name').value,
            price: parseFloat(document.getElementById('crop-price').value),
            unit: document.getElementById('crop-unit').value,
            type: document.getElementById('crop-type').value,
            eta: document.getElementById('crop-eta').value,
            image: `https://placehold.co/400x300/CCCCCC/FFFFFF?text=${encodeURIComponent(document.getElementById('crop-name').value)}`
        };

        if (id) {
            const index = crops.findIndex(c => c.id == id);
            crops[index] = { ...crops[index], ...cropData };
        } else {
            crops.push(cropData);
        }
        
        renderCrops();
        cropModal.classList.add('hidden');
    });

    // --- NEW: Profile Edit/Save/Cancel Logic ---
    profileActions.addEventListener('click', (e) => {
        const targetId = e.target.id;
        if (!targetId) return;

        const nameContainer = document.getElementById('profile-name-container');
        const locationContainer = document.getElementById('profile-location-container');

        if (targetId === 'edit-profile-btn') {
            // Switch to Edit Mode
            nameContainer.innerHTML = `
                <label for="profile-name-input" class="font-semibold text-gray-600">Name</label>
                <input type="text" id="profile-name-input" class="w-full mt-1 p-2 border rounded-md text-lg" value="${farmerProfile.name}">
            `;
            locationContainer.innerHTML = `
                <label for="profile-location-input" class="font-semibold text-gray-600">Location</label>
                <input type="text" id="profile-location-input" class="w-full mt-1 p-2 border rounded-md text-lg" value="${farmerProfile.location}">
            `;
            profileActions.innerHTML = `
                <button id="save-profile-btn" class="px-4 py-2 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700">Save Changes</button>
                <button id="cancel-profile-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 ml-2">Cancel</button>
            `;
        }

        if (targetId === 'save-profile-btn' || targetId === 'cancel-profile-btn') {
            // Save Changes (if applicable) and Switch to View Mode
            if (targetId === 'save-profile-btn') {
                const newName = document.getElementById('profile-name-input').value;
                const newLocation = document.getElementById('profile-location-input').value;
                farmerProfile.name = newName;
                farmerProfile.location = newLocation;
            }

            // Restore the original HTML structure for the view
            nameContainer.innerHTML = `
                <label class="font-semibold text-gray-600">Name</label>
                <p id="profile-name" class="text-lg"></p>
            `;
            locationContainer.innerHTML = `
                <label class="font-semibold text-gray-600">Location</label>
                <p id="profile-location" class="text-lg"></p>
            `;
            profileActions.innerHTML = `
                <button id="edit-profile-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-600">Edit Profile</button>
            `;

            // Re-render the profile with the (potentially new) data
            renderProfile();
        }
    });

    // --- INITIALIZATION ---
    renderOrders();
    renderCrops();
    renderProfile();
});
</script>

</body>
</html>